{~add-ons/Creep_War/shop/shop.cfg}

#define CW_ADD_GOLD SIDE AMOUNT
[gold]
	side={SIDE}
	amount={AMOUNT}
	[/gold]
#enddef

#define CW_KILL_SIDE SIDE
[kill]
	side={SIDE}
	[/kill]
#enddef

#define CW_UNIT_GUARD_INCREASE_HP TEAM GUARD_NUM AMOUNT
[object]
	silent=yes
	[filter]
		id=CW_Guard_{TEAM}{GUARD_NUM}
		[/filter]
	[effect]
		apply_to=hitpoints
		increase_total={AMOUNT}
		increase={AMOUNT}
		[/effect]
	[/object]
#enddef

#define CW_UPDATE_SCORE
	[print]
		text="$killwest| : $killeast|"
		size=24
		red=255
		duration=110
		[/print]
	[label]
		x=18
		y=9
		text="

$killwest| : $killeast|"
		[/label]
	[label]
		x=18
		y=10
		text="$gold_W|g : $gold_E|g"
		[/label]
#enddef

#define Advance_To
	[store_unit]
		[filter]
			canrecruit=yes
			[/filter]
		variable=units
		[/store_unit]
	{FOREACH units i}
		[set_variable]
			name=units[$i].variables.advance
			value=$units[$i].advances_to
			[/set_variable]
		[set_variables]
			name=tmp
			mode=replace
			[split]
				list=$units[$i].variables.advance|
				key=item
				separator=","
				[/split]
			[/set_variables]
		[set_variable]
			name=units[$i].variables.num_advance
			value=$tmp.length
			[/set_variable]
		[unstore_unit]
			variable=units[$i]
			[/unstore_unit]
		{NEXT i}
	[unstore_unit]
		variable=units
		[/unstore_unit]
	[set_menu_item]
		id=Badvanceto
		description= _ "Advance toâ€¦"
		[show_if]
			[have_unit]
				side=$side_number
				canrecruit=yes
				x=$x1
				y=$y1
				[/have_unit]
			[variable]
				name=unit.variables.num_advance
				greater_than_equal_to=2
				[/variable]
			[/show_if]
		[command]
			[set_variables]
				name=advance
				mode=replace
				[split]
					list=$unit.variables.advance|
					key=item
					separator=","
					[/split]
				[/set_variables]
			{FOREACH advance i}
				[unit]
					type=$advance[$i].item
					to_variable=unit_type_$i|
					[/unit]
				{NEXT i}
			[message]
				speaker=unit
				message= _ "This unit is set to advance to: $unit.advances_to|"
				[option]
					message= _ "back"
					[/option]
				[option]
					message= _ {MENU_IMG_TXT $unit_type_0.image| "$advance[0].item|"}
					[show_if]
						[variable]
							name=advance.length
							greater_than_equal_to=1
							[/variable]
						[/show_if]
					[command]
						[set_variable]
							name=unit.advances_to
							value=$advance[0].item|
							[/set_variable]
						[unstore_unit]
							variable=unit
							[/unstore_unit]
						[/command]
					[/option]
				[option]
					message= _ {MENU_IMG_TXT $unit_type_1.image| "$advance[1].item|"}
					[show_if]
						[variable]
							name=advance.length
							greater_than_equal_to=2
							[/variable]
						[/show_if]
					[command]
						[set_variable]
							name=unit.advances_to
							value=$advance[1].item|
							[/set_variable]
						[unstore_unit]
							variable=unit
							[/unstore_unit]
						[/command]
					[/option]
				[option]
					message= _ {MENU_IMG_TXT $unit_type_2.image| "$advance[2].item|"}
					[show_if]
						[variable]
							name=advance.length
							greater_than_equal_to=3
							[/variable]
						[/show_if]
					[command]
						[set_variable]
							name=unit.advances_to
							value=$advance[2].item|
							[/set_variable]
						[unstore_unit]
							variable=unit
							[/unstore_unit]
						[/command]
					[/option]
#				[option]
#					message= _ "I don't want to advance (AMLA)"
#					[command]
#						[set_variable]
#							name=unit.advances_to
#							value=null
#						[/set_variable]
#						[unstore_unit]
#							variable=unit
#						[/unstore_unit]
#					[/command]
#				[/option]
				[option]
					message= _ "I want to choose later"
					[command]
						[set_variable]
							name=unit.advances_to
							value=$unit.variables.advance
							[/set_variable]
						[unstore_unit]
							variable=unit
							[/unstore_unit]
						[/command]
					[/option]
				[/message]
			[/command]
		[/set_menu_item]
#enddef

#define Post_Advance
	[event]
		name=post advance
		first_time_only=no
		[clear_variable]
			name=unit.variables.advance
		[/clear_variable]
		{VARIABLE unit.variables.advance $unit.advances_to|}
		[set_variables]
			name=tmp
			mode=replace
			[split]
				list=$unit.variables.advance|
				key=item
				separator=","
			[/split]
		[/set_variables]
		[set_variable]
			name=unit.variables.num_advance
			value=$tmp.length
		[/set_variable]
		[unstore_unit]
			variable=unit
			find_vacant=no
		[/unstore_unit]
	[/event]
#enddef

#define teleport x y SIDE
	[event]
		name=side turn
		first_time_only=no
		[if]
			[variable]
				name=side_number
				equals={SIDE}
			[/variable]
			[then]
				[if]
					[variable]
						name=hero_{SIDE}
						equals=on_start_pos
					[/variable]
					[then]
						[teleport]
							[filter]
								side={SIDE}
								canrecruit=yes
							[/filter]
							x={x}
							y={y}
						[/teleport]
						[set_variable]
							name=hero_{SIDE}
							value=alive
						[/set_variable]
					[/then]
				[/if]
				[if]
					[variable]
						name=hero_{SIDE}
						equals=dead
					[/variable]
					[then]
						[unstore_unit]
							variable=dead_hero_{SIDE}
							x={x}
							y={y}
							find_vacant=yes
						[/unstore_unit]
						[set_variable]
							name=hero_{SIDE}
							value=alive
						[/set_variable]
					[/then]
				[/if]
				[if]
					[variable]
						name=hero_{SIDE}
						equals=dead_wait
					[/variable]
					[then]
						[set_variable]
							name=hero_{SIDE}
							value=dead
						[/set_variable]
					[/then]
				[/if]
			[/then]
		[/if]
	[/event]
#enddef

#define hero_die enemy1 enemy2 enemy3 x y kill TEAM SIDE
	[event]
		name=die
		first_time_only=no
		[filter]
			side={SIDE}
			canrecruit=yes
			[/filter]
		[object]
			silent=yes
			[effect]
				apply_to=hitpoints
				heal_full=yes
				[/effect]
			[effect]
				apply_to=status
				remove=poisoned
				[/effect]
			[effect]
				apply_to=status
				remove=slowed
				[/effect]
		[/object]
		[store_unit]
			[filter]
				side={SIDE}
				canrecruit=yes
				[/filter]
			variable=dead_hero_{SIDE}
			kill=yes
			[/store_unit]
		{VARIABLE hero_{SIDE} dead_wait}
		{VARIABLE_OP gold_{TEAM} add 20}
		{CW_ADD_GOLD {enemy1} 20}
		{CW_ADD_GOLD {enemy2} 20}
		{CW_ADD_GOLD {enemy3} 20}
		{VARIABLE_OP {kill} add 3}
		{CW_UNIT_GUARD_INCREASE_HP {TEAM} 1 3}
		{CW_UNIT_GUARD_INCREASE_HP {TEAM} 2 3}
		{VARIABLE_OP guard_{TEAM}_plus_hitpoints add 3}
		{CW_UPDATE_SCORE}
	[/event]
#enddef
#define teleport_back_MI x y SIDE
	[set_menu_item]
		id=Teleport{SIDE}
		description= _ "Teleport in game"
		[filter_location]
			y=2
		[/filter_location]
		[show_if]
			[have_unit]
				side={SIDE}
				canrecruit=yes
				x=$x1
				y=$y1
				[/have_unit]
			{VARIABLE_CONDITIONAL side_number equals {SIDE}}
		[/show_if]
		[command]
			[if]
				[variable]
					name=hero_{SIDE}
					equals=on_start_pos
					[/variable]
				[then]
					[teleport]
						[filter]
							side={SIDE}
							canrecruit=yes
							[/filter]
						x={x}
						y={y}
						[/teleport]
					{VARIABLE hero_{SIDE} alive}
				[/then]
			[/if]
		[/command]
	[/set_menu_item]
#enddef

#define Bank_interest
	[event]
		name=side turn
		first_time_only=no
		[set_variable]
			name=bank_$side_number
			multiply=1.025
		[/set_variable]
	[/event]
#enddef

#define Enable_Ancient_Lich
	[event]
		name=post advance
		first_time_only=no
		[filter]
			type=Lich
		[/filter]
		{VARIABLE unit.advances_to "Ancient Lich"}
		[unstore_unit]
			variable=unit
			find_vacant=no
		[/unstore_unit]
	[/event]
#enddef

#define CW_HUMAN_PLAYER_SETTINGS TEAM SIDE PLAYERNUM
	[side]
		description={TEAM} Player {PLAYERNUM}
		side={SIDE}
		team_name={TEAM}
		canrecruit=yes
		controller=human
		gold=100
		income=-2
		team_lock=yes
		gold_lock=yes
		income_lock=yes
		share_view=yes
	[/side]
#enddef

#define CW_CREEP_PLAYER_SETTINGS TEAM SIDE
	[side]
		description={TEAM} Creeps
		side={SIDE}
		team_name={TEAM}
		controller=ai
		gold=100
		income=-2
		allow_player=no
		team_lock=yes
		gold_lock=yes
		income_lock=yes
		share_view=yes
		canrecruit=yes
		[ai]
			aggression=0.9
			caution=0.0
			village_value=0.0
#ifdef CW_USE_MAIN_MAP
			leader_value=3.0
#endif
#ifndef CW_USE_MAIN_MAP
			leader_value=5.0
#endif
			[avoid]
#ifndef CW_USE_THREE_TEAM
				x=8,8,28,28,11,11,11,11,25,25,25,25
				y=9,11,9,11,9,10,11,12,9,10,11,12
#endif
#ifdef CW_USE_THREE_TEAM
				x=7,5,27,29,15,19
				y=8,11,8,11,26,26
#endif
				[/avoid]
			[/ai]
		[/side]
#enddef

#define CW_ADD_SHOP_TO_MAP X_POS Y_POS
	[item]
		x={X_POS}
		y={Y_POS}
		image=terrain/castle/encampment/tent.png
	[/item]
		[label]
		x={X_POS}
		y={Y_POS}
		text=Shop
	[/label]
#enddef

#define CW_RANDOM_UNIT_VAR
	[set_variable]
		name=my_unit
		rand=Drake Burner,Drake Clasher,Drake Fighter,Drake Glider,Dwarvish Fighter,Dwarvish Guardsman,Dwarvish Scout,Dwarvish Thunderer,Gryphon Rider,Elvish Archer,Elvish Fighter,Elvish Scout,Elvish Shaman,Wolf Rider,Thief,Thug,Footpad,Poacher,Dark Adept,Sergeant,Spearman,Bowman,Horseman,Cavalryman,Fencer,Heavy Infantryman,Mage,Saurian Augur,Saurian Skirmisher,Merman Fighter,Mermaid Initiate,Merman Fighter,Merman Hunter,Naga Fighter,Orcish Grunt,Orcish Leader,Orcish Archer,Orcish Assassin,Ghoul,Skeleton,Skeleton Archer
	[/set_variable]
#enddef

#define CW_STORE_UNIT_T TYPE SIDE VAR KILL
	[store_unit]
		[filter]
			type={TYPE}
			side={SIDE}
			canrecruit=yes
		[/filter]
		variable={VAR}
		kill={KILL}
	[/store_unit]
#enddef

#define CW_STORE_UNIT SIDE VAR KILL
	[store_unit]
		[filter]
			side={SIDE}
			canrecruit=yes
		[/filter]
		variable={VAR}
		kill={KILL}
	[/store_unit]
#enddef

#define CW_UNIT TYPE ID NAME SIDE CANRECRUIT X Y
[unit]
	type={TYPE}
	id={ID}
	name={NAME}
	side={SIDE}
	canrecruit={CANRECRUIT}
	x={X}
	y={Y}
	random_traits=no
	[/unit]
#enddef

#define CW_MIRROR_REPLACE_IF SOURCE TARGET
	{CW_STORE_UNIT_T "Fog Clearer" {TARGET} clone yes}
	{FOREACH clone i}
		[if]
			[have_unit]
				side={SOURCE}
				canrecruit=yes
			[/have_unit]
			[then]
				{CW_UNIT $clonable{SOURCE}.type $clone[$i].id $clone[$i].name $clone[$i].side $clone[$i].canrecruit $clone[$i].x $clone[$i].y}
			[/then]
			[else]
				{CW_RANDOM_UNIT_VAR}
				{CW_UNIT $my_unit $clone[$i].id $clone[$i].name $clone[$i].side $clone[$i].canrecruit $clone[$i].x $clone[$i].y}
			[/else]
		[/if]
	{NEXT i}
#enddef

#define CW_MIRROR_REPLACE
# Spearman is the error prevention unit
	{CW_STORE_UNIT_T "Fog Clearer" 1,3,6 mirror yes}
	{FOREACH mirror i}
		{CW_RANDOM_UNIT_VAR}
		{CW_UNIT $my_unit $mirror[$i].id $mirror[$i].name $mirror[$i].side $mirror[$i].canrecruit $mirror[$i].x $mirror[$i].y}
	{NEXT i}

	{CW_STORE_UNIT 1 clonable1 no}
	{CW_STORE_UNIT 3 clonable3 no}
	{CW_STORE_UNIT 6 clonable6 no}

	{CW_MIRROR_REPLACE_IF 6 2}
	{CW_MIRROR_REPLACE_IF 1 5}
	{CW_MIRROR_REPLACE_IF 3 7}
#enddef

#define CW_DEF_RESIST_ARRAY ARRNAME
[set_variables]
	name={ARRNAME}
	[value]
		name="arcane"
		[/value]
	[value]
		name="blade"
		[/value]
	[value]
		name="cold"
		[/value]
	[value]
		name="fire"
		[/value]
	[value]
		name="impact"
		[/value]
	[value]
		name="pierce"
		[/value]
	[/set_variables]
#enddef

#define CW_ITEMS_INIT
	{CW_ITEMS_ARMOR_INIT}
	{CW_ITEMS_RESISTANCE_INIT}
	{CW_ITEMS_WEAPON_INIT}
#enddef

#define CW_UNIT_GUARD_CREATE TEAM NUMBER X_POS Y_POS SIDE
	[unit]
		type=Lieutenant
		id=CW_Guard_{TEAM}{NUMBER}
		name=Guard
		side={SIDE}
		x={X_POS}
		y={Y_POS}
		random_traits=no
#ifndef CW_USE_REVIVE_GUARD
		canrecruit=yes
#endif
		[modifications]
			[object]
				[effect] 
					apply_to=hitpoints 
					increase_total=10
					heal_full=yes
					[/effect]
				[effect] 
					apply_to=attack
					range=melee
					increase_damage=-3
					increase_attacks=1
					[/effect]
				[effect]
					apply_to=attack
					range=ranged
					increase_damage=0
					increase_attacks=1
					[/effect]
				[effect]
					apply_to=max_experience
					increase=99920
					[/effect]
				[effect]
					apply_to=movement
					set=0
					[/effect]
				[effect]
					apply_to=resistance
					replace=true
					[resistance]
						arcane=100
						blade=100
						cold=100
						fire=100
						impact=100
						pierce=100
						[/resistance]
					[/effect]
				[/object]
			[/modifications]
		to_variable=guard_var
		[/unit]
	[set_variable]
		name=guard_var.alignment
		value=neutral
		[/set_variable]
	[unstore_unit]
		variable=guard_var
		[/unstore_unit]
#enddef

#define CW_OBJECT_MOVEMENT AMOUNT
[object]
	silent=yes
	[effect]
		apply_to=movement
		increase={AMOUNT}
		[/effect]
	[/object]
#enddef

#define CW_OBJECT_HITPOINTS AMOUNT PERCENTAGE
[object]
	silent=yes
	[effect]
		apply_to=hitpoints
		increase_total={AMOUNT}
		[/effect]
	[effect]
		apply_to=hitpoints
		increase_total={PERCENTAGE}%
		[/effect]
	[/object]
#enddef
